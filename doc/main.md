
---

# プログラム詳細設計書

## 1. プログラム名

`main.py`

## 2. 処理概要

カフェシミュレーションアプリのメイン制御を行う。
`pyglet` を使用し、画面描画、イベント処理、時間管理を行う。
また、`Map`・`CustomerManager`・`SeatManager` を生成し、それぞれに制御権を渡す。

## 3. 処理詳細

### 3.1 インポートモジュール

* **pyglet**: 画面描画・イベント処理用
* **pyglet.window\.key**: キー入力判定用
* **settings**: シミュレーションの定数（MAP\_DATA, CELL\_SIZEなど）
* **map.Map**: マップ描画とマウスイベント管理
* **customerManager.CustomerManager**: 顧客管理（生成、行動、削除など）
* **seat\_manager.SeatManager**: 座席管理（座席割り当て、解放など）
* **time**: 経過時間の記録とログ用

---

### 3.2 クラス名

`Main`

---

### 3.3 メソッド一覧

| No | Name             | 説明                                                    | 備考         |
| -- | ---------------- | ----------------------------------------------------- | ---------- |
| 1  | `__init__`       | 初期化処理。ウィンドウ生成、Map/Customer/SeatManager初期化、イベント登録、ログ開始 | 外部から呼び出される |
| 2  | `_create_logger` | ログ出力関数を生成し、関数として返す                                    | class内部使用  |
| 3  | `close`          | ログファイルをクローズする                                         | 終了処理       |
| 4  | `on_draw`        | 画面描画イベント処理                                            | pygletイベント |
| 5  | `on_mouse_press` | マウス入力イベント処理。Mapに処理を委譲                                 | pygletイベント |
| 6  | `on_key_press`   | キー入力イベント処理（ESC:終了, N:新規ウィンドウ要求）                       | pygletイベント |
| 7  | `update`         | 毎フレーム更新処理。Customer/SeatManagerに処理を委譲                  | 1/60秒ごと    |

---

### 3.3.1 コンストラクタ (`__init__`)

**引数**

| No | Name  | 説明                          |
| -- | ----- | --------------------------- |
| 1  | title | ウィンドウタイトル（デフォルト "SIM CAFE"） |

**処理内容**

* ログファイルを作成し、基準時間を記録
* ログ関数を生成して各マネージャーに渡す
* ウィンドウサイズをMAP\_DATAとCELL\_SIZEから計算
* `pyglet.window.Window` の生成（描画イベント登録含む）
* `Map`・`CustomerManager`・`SeatManager` のインスタンス生成
* イベントハンドラ登録 (`on_draw`, `on_mouse_press`, `on_key_press`)
* `pyglet.clock.schedule_interval` により `update` を60FPSで呼び出すよう設定

---

### 3.3.2 `_create_logger`

**引数**: なし
**戻り値**: ログ関数（messageを文字列で受け取り、`customer_lifecycle.log`に書き込む関数）

**処理内容**

* 現在時刻からの経過秒数を計算し、メッセージをログファイルに追記

---

### 3.3.3 `close`

**引数**: なし
**戻り値**: なし

**処理内容**

* ログファイルを安全にクローズする

---

### 3.3.4 `on_draw`

**引数**: なし
**戻り値**: なし

**処理内容**

* ウィンドウをクリア
* `batch.draw()` により全スプライトを描画
* 描画エラーが発生した場合、標準出力にエラーメッセージを表示

---

### 3.3.5 `on_mouse_press`

**引数**

| No | Name      | 型   | 説明            |
| -- | --------- | --- | ------------- |
| 1  | x         | int | マウスクリック位置のX座標 |
| 2  | y         | int | マウスクリック位置のY座標 |
| 3  | button    | int | 押下されたボタン番号    |
| 4  | modifiers | int | 修飾キー状態        |

**処理内容**

* `Map.on_mouse_press()` に処理を委譲

---

### 3.3.6 `on_key_press`

**引数**

| No | Name      | 型   | 説明            |
| -- | --------- | --- | ------------- |
| 1  | symbol    | int | 押下されたキーのキーコード |
| 2  | modifiers | int | 修飾キー状態        |

**処理内容**

* ESCキー → ウィンドウを閉じる
* Nキー   → 新規ウィンドウ要求を標準出力に表示

---

### 3.3.7 `update`

**引数**

| No | Name | 型     | 説明               |
| -- | ---- | ----- | ---------------- |
| 1  | dt   | float | 前回フレームからの経過時間（秒） |

**処理内容**

* `CustomerManager.update()` を呼び、顧客の生成・移動・削除処理を進行
* `SeatManager.update()` を呼び、座席割り当てや解放を処理

---

## 3.4 外部インターフェース

### 3.4.1 インスタンス宣言

```python
game = Main()
```

### 3.4.2 実行

```python
pyglet.app.run()
```

アプリが起動し、顧客が順次生成され、座席に移動するシミュレーションが開始される。

---
